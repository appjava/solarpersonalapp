<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Personal APP </title>
    
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        body{
            text-align: center;
            width: 100%;
            background-color: red;
            color: white;
            font-size: 12px;

        }
        table{
            background-color: rgb(230, 169, 3);
            margin: 6px auto 0px auto;
            width: 100%;
            border-radius: 12px 12px 0px 0px;
            padding: 6px 12px 12px 12px;
            font-size: x-small;
        }
        thead {
            background-color: rgb(230, 169, 3);
            border-radius: 12px 12px 0px 0px;
            color: white;
            font-size: x-small;
            text-transform: uppercase;
        }
        tbody{
            background-color: white;
            color: black;
        }
        td{
            padding: 3px;
        }
        
        fieldset{
            width: 90%;
            min-width: 240px;
            margin: 12px auto;
            border-radius: 12px 12px 12px 12px;
            padding: 3px 9px 12px 9px;
        }
        legend{
            font-weight: bold;
        }
        button{
            width: 100%;
            font-weight: bold;
            font-size: 15px;
            height: 45px;
            border-radius: 0px 0px 12px 12px;
            margin-bottom: 12px;
            margin-top: 0px;
            text-transform: uppercase;
            background-color: rgb(230, 169, 3);
            color: white;
            cursor: pointer;
        }
        img{
            border-radius: 0px 0px 12px 12px;
            width: 100%;
        }
        input{
            text-align: center;
            width: 60%;
            background-color: white;
            border-radius: 6px;
            margin: 3px;
            font-size: small;
        }
        label{
            font-weight: bold;
        }
        #radiacion{
            background-color: rgb(230, 169, 3);
            color: white;
            font-weight: bold;
        }
        #solRadar{
            max-width: 100%;
            height: 240px;
            border: 1px solid white;
            background-color: white;
            font-size: 12px;
        }
        .local{
            width: 40px;
            height: 40px;
            font-size: x-small;
            position: absolute;
            top: 30px;
            right: 5%;
            background: white;
            color: rgb(230, 169, 3);
            border-radius: 20px;
            padding-left: 0px;
            padding-right: 0px;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function(){
            readDay();
            });

        function readDay(){
            let lat = document.getElementById("lat").value;
            let lon = document.getElementById("lon").value;

            if (!lat || !lon){
                    console.log("Por Defecto: ");
                    lat = 3.559809;
                    lon = -76.575405;
                    console.log(lat);
                    console.log(lon);
                }
                else {
                    console.log("Input: ");
                    console.log(lat);
                    console.log(lon);
                }
            const urlINI = 'https://api.open-meteo.com/v1/forecast?';
            const urlA = 'latitude='+lat;
            const urlB = 'longitude='+lon;
            const urlC = 'current=temperature_2m,relative_humidity_2m';
            const urlD = 'hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,shortwave_radiation,direct_radiation,diffuse_radiation';
            const urlE = 'daily=temperature_2m_max,temperature_2m_min';
            const urlEND = 'wind_speed_unit=ms&timezone=auto&forecast_days=1&models=best_match';
            const urlAPI = urlINI +'&'+ urlA +'&'+ urlB +'&'+ urlC +'&'+ urlD +'&'+ urlE +'&'+ urlEND;
            console.log(urlAPI);

            fetch(urlAPI)
            .then(response => response.json())
            .then(data => {

                let zonaHoraria = data.timezone;
                let elevacion = data.elevation;
                let latitud = data.latitude;
                let longitud = data.longitude;

                //Current
                let temperatura = data.current.temperature_2m;
                let humedad = data.current.relative_humidity_2m;
            
                //Hourly
                let tiempo = data.hourly.time;
                let radiacionCorta = data.hourly.shortwave_radiation;
                let viento = data.hourly.wind_speed_10m;

                let eficiencia = 0.15;

                const radEfectiva = radiacionCorta.map( number => eficiencia * number);
                const eEolica = viento.map( number => 0.4 * (number*number*number));
                
                let totalEolica = 0;
                eEolica.forEach( num => {
                    totalEolica += num;
                });
               
                console.log("Radiacion Efectiva: ");
                console.log(radEfectiva);

                console.log(data);

                console.log(data.latitude);
                console.log(data.longitude);
                console.log(zonaHoraria);
                console.log(data.hourly.time[12]);

                console.log(tiempo);
                console.log(radiacionCorta);
                console.log(viento);

                const media = mean => {
                    if (mean.length < 1){
                        return;
                    }
                    return mean.reduce((prev, current) => prev + current) / mean.length;
                };

                let mediaViento = media(viento);
                let maxViento = Math.max.apply(null,viento);

                let totalW = 0;
                for (let i = 0; i < radEfectiva.length; i++){
                    totalW += radEfectiva[i];
                }
                console.log("Total Energy: " + parseInt(totalW) + " Wh/m2");

                let mediaWind = 0;
                viento.forEach( num => {
                    mediaWind += num;
                });

                let mViento = mediaWind/viento.length;

                console.log("Radiation: " + data.hourly.shortwave_radiation[12] + " W/m2");
                console.log("Wind: " + data.hourly.wind_speed_10m[12] + " m/s");
                
                console.log("Wind Media: " + mViento + " m/s");
                console.log(maxViento);

                document.getElementById("boton").innerHTML=data.daily.time[0];
                document.getElementById("zonaHoraria").innerHTML=zonaHoraria;
                document.getElementById("latitud").innerHTML=latitud;
                document.getElementById("longitud").innerHTML=longitud;
                document.getElementById("elevacion").innerHTML=elevacion;
                document.getElementById("temperatura").innerHTML=temperatura;
                document.getElementById("humedad").innerHTML=humedad;
                document.getElementById("radiacion").innerHTML=parseInt(totalW);
                document.getElementById("maxViento").innerHTML= maxViento;
                document.getElementById("mediaViento").innerHTML= mediaViento.toFixed(2);
                document.getElementById("energiaEolica").innerHTML= parseInt(totalEolica);
                
                const ctx = document.getElementById('solRadar');
                const ctx2 = document.getElementById('solGen');
                

                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(radiacionCorta),
                        datasets: [
                            {
                            axis: 'x',
                            label: 'Wh/m2',
                            data: Object.values(radEfectiva),
                            borderWidth: 1,
                            fill: true,
                            borderColor: 'rgb(23, 69, 3)',
                            backgroundColor: 'rgb(230, 169, 3)',
                            tension: 0.3,
                            },

                        ]
                    },
                    options: {
                        scales: {
                            y: {beginAtZero: true}
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Hourly Energy Generation',
                                padding: {
                                    top: 6,
                                    bottom: 0
                                }
                            },
                        }
                    }
                });
                
            });

        }

        function clearDay(){
            myChart.clear();
            myChart.destroy();
            readDay();
        }
    </script>

</head>
<body>
    <fieldset>
        <legend id="dia">EchoWeather</legend>
    <p><label>Latitude:</label><input id="lat" type="number" placeholder="3.375"></p>
    <p><label>Longitude:</label><input id="lon" type="number"placeholder="-76.75"></p>
    <a id=local href="https://www.google.com/maps" target="_blank"><button class="local">Map</button></a>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>Und</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>TimeZone</td>
                <td id="zonaHoraria"></td>
                <td>-</td>
            </tr>
            <tr>
                <td>Latitude</td>
                <td id="latitud"></td>
                <td>°</td>
            </tr>
            <tr>
                <td>Longitude</td>
                <td id="longitud"></td>
                <td>°</td>
            </tr>
            <tr>
                <td>Elevation</td>
                <td id="elevacion"></td>
                <td>msnm</td>
            </tr>
            <tr>
                <td>Temperature</td>
                <td id="temperatura"></td>
                <td>°C</td>
            </tr>
            <tr>
                <td>Humidity</td>
                <td id="humedad"></td>
                <td>%</td>
            </tr>
            <tr>
                <td>Daily PV Energy</td>
                <td id="radiacion"></td>
                <td>Wh/m2</td>
            </tr>
            <tr>
                <td>Wind Velocity (max)</td>
                <td id="maxViento"></td>
                <td>m/s</td>
            </tr>
            <tr>
                <td>Wind Velocity (avg)</td>
                <td id="mediaViento"></td>
                <td>m/s</td>
            </tr>
            <tr>
                <td>Daily Eolic Potential</td>
                <td id="energiaEolica"></td>
                <td>W/m2</td>
            </tr>
        </tbody>
    </table>
    <!--<img src="home.jpg" alt="Loading ...">-->
    <canvas id="solRadar"></canvas>
    <button id="boton" onclick="clearDay()">Press to Scan Present Day</button>
    <h5>Powered by Open-Meteo</h5>
    </fieldset>
    
</body>
</html>